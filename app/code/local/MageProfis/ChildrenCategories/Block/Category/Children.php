<?phpclass MageProfis_ChildrenCategories_Block_Category_Children extends Mage_Core_Block_Template {    protected $_subcats = null;    public $_path = null;    public $_limit = null;    protected function _construct() {        $this->setLimit(Mage::getStoreConfig('childrencategories/general/amount'));                parent::_construct();        $this->addData(array('cache_lifetime' => 43200)); // 12 hours        $this->addCacheTag(array(            Mage_Catalog_Model_Category::CACHE_TAG,        ));    }    public function getCurrentCategory() {        return Mage::registry('current_category');    }        public function setLimit($limit)    {        $this->_limit = $limit;       }        public function getLimit()    {        return $this->_limit;    }        public function getCacheKeyInfo() {        return array(            Mage::app()->getStore()->getId(),            Mage::getDesign()->getPackageName(),            Mage::getDesign()->getTheme('template'),            $this->getCurrentCategory()->getId()        );    }    public function getChildrenCategories() {        if (is_null($this->_subcats)) {            $_subcats = Mage::getModel('catalog/category')->getCollection()                    ->addAttributeToSelect('*')                    ->addAttributeToFilter('parent_id', $this->getCurrentCategory()->getId())                    ->addAttributeToFilter('show_in_parent', 1)                    ->addAttributeToSort('parent_position', 'ASC')                    ->addIsActiveFilter()                    ->addUrlRewriteToResult();            if ($this->getLimit() != null) {                $_subcats->setPageSize($this->getLimit());                $_subcats->setCurPage(1);            }            foreach ($_subcats as $item) {                $this->addCacheTag(Mage_Catalog_Model_Category::CACHE_TAG . '_' . $item->getId());                if ($item->getProductCount() == 0) {                    $_subcats->removeItemByKey($item->getId());                }            }            $_subcats->setOrder('order');            $this->_subcats = $_subcats;        }        return $this->_subcats;    }    public function getImagesDir() {        if ($this->_path == null) {            $this->_path = Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_MEDIA) . 'catalog/category/';        }        return $this->_path;    }    protected function _toHtml() {        if (!Mage::getStoreConfigFlag('childrencategories/general/active')) {            return '';        }        return parent::_toHtml();    }}